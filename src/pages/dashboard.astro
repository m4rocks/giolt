---
import DashboardWrapper from "@/components/dashboard/wrapper";
import { blogPosts, organizations } from "@/db/schema";
import Layout from "@/layouts/dashboard-layout.astro";
import { protectRoute } from "@/lib/clerk";
import { db } from "@/lib/db";
import { eq } from "drizzle-orm";

const { orgId } = Astro.locals.auth();

const res = await protectRoute(Astro, {
	needsSelectedOrg: true,
});
if (res) return res;

const org = await db
	.select()
	.from(organizations)
	.where(eq(organizations.id, orgId as string))
	.get();

if (!org) {
	return Astro.redirect("/select");
}

const blog = await db
	.select()
	.from(blogPosts)
	.where(eq(blogPosts.organizationId, orgId as string))
	.all();
---

<Layout
	title={org.name}
	class="flex flex-col"
>
	<DashboardWrapper
		org={org}
		blog={blog}
		client:only="react"
	/>
</Layout>

<style is:global>
	.cl-organizationProfile-root {
		flex: 1;
		width: 100%;
		height: 100%;
	}

	.cl-organizationProfile-root > .cl-cardBox {
		width: 100%;
		height: 100%;
		max-width: none;
		box-shadow: none;
		border: none;
		border-radius: 0;
	}

	.cl-organizationProfile-root .cl-navbar {
		z-index: 99;
		width: 100%;
	}

	.cl-organizationProfile-root .cl-scrollBox {
		height: calc(100vh - 4rem);
	}

	@media (min-width: 768px) {
		.cl-organizationProfile-root .cl-scrollBox {
			margin-left: calc(var(--clerk-spacing, 1rem) * 17);
			width: calc(100vw - var(--clerk-spacing, 1rem) * 17);
		}

		.cl-organizationProfile-root .cl-navbar {
			position: fixed;
			height: calc(100% - 4rem);
			max-width: calc(var(--clerk-spacing, 1rem) * 17);
		}
	}
</style>
