---
import Blog from "@/components/org/pages/blog.astro";
import Home from "@/components/org/pages/home.astro";
import { blogPosts, organizations } from "@/db/schema";
import Layout from "@/layouts/tenant-layout.astro";
import { db } from "@/lib/db";
import { and, eq } from "drizzle-orm";

const { id, slug } = Astro.params;

if (!slug) {
	throw new Error("Slug is required");
}

if (!id) {
	return Astro.redirect("/");
}

const org = await db
	.select()
	.from(organizations)
	.where(eq(organizations.slug, slug))
	.get();

if (!org) {
	throw new Error("Organization not found");
}

const post = await db
	.select()
	.from(blogPosts)
	.where(
		and(
			eq(blogPosts.id, Number.parseInt(id)),
			eq(blogPosts.organizationId, org.id),
			eq(blogPosts.draft, false),
		),
	)
	.get();

if (!post) {
	return Astro.redirect("/");
}
---

<Layout
	title={org.name}
	theme={org.theme}
	navbar
	favicon={org.logoUrl || undefined}
>
	<Blog
		orgId={org.id}
		post={post}
	/>
</Layout>
